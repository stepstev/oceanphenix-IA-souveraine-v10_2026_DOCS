<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Dashboard - OceanPhenix Admin Hub</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/img/logo-oceanphenix.svg">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet"/>
    <link href="../assets/css/oceanphenix-theme.css" rel="stylesheet"/>
</head>
<body>
    <div class="page">
        <!-- Navbar -->
        <header class="navbar navbar-expand-md navbar-light d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="../index.html">
                        <i class="ti ti-circle-filled text-primary navbar-logo-icon"></i>
                        <span class="navbar-brand-text ms-2">OceanPhenix</span>
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <!-- API Status -->
                    <div class="nav-item d-none d-md-flex me-3">
                        <div class="btn-list">
                            <a href="#" class="btn" id="header-api-status-item">
                                <span class="status-dot status-dot-animated bg-success" id="api-status-indicator"></span>
                                <span id="api-status-text">API Connect√©e</span>
                            </a>
                        </div>
                    </div>
                    <!-- Theme Toggle -->
                    <div class="nav-item d-none d-md-flex me-3">
                        <a href="#" class="nav-link px-0" id="theme-toggle" title="Changer le th√®me">
                            <i class="ti ti-moon"></i>
                        </a>
                    </div>
                    <!-- User Menu -->
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm bg-primary-lt">
                                <i class="ti ti-user"></i>
                            </span>
                            <div class="d-none d-xl-block ps-2">
                                <div id="user-name">Administrateur</div>
                                <div class="mt-1 small text-muted" id="user-email">admin@oceanphenix.fr</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="settings.html" class="dropdown-item">
                                <i class="ti ti-settings me-2"></i>Param√®tres
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="../index.html" class="dropdown-item" onclick="App.logout()">
                                <i class="ti ti-logout me-2"></i>D√©connexion
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Navbar Menu -->
        <header class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar navbar-light">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item active">
                                <a class="nav-link" href="dashboard.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-dashboard"></i>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="studio.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-sparkles"></i>
                                    </span>
                                    <span class="nav-link-title">AI Studio</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="admin.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-settings"></i>
                                    </span>
                                    <span class="nav-link-title">Console Admin</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="architecture.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-layout-dashboard"></i>
                                    </span>
                                    <span class="nav-link-title">Architecture</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="components.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-components"></i>
                                    </span>
                                    <span class="nav-link-title">Composants</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="docs.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-book"></i>
                                    </span>
                                    <span class="nav-link-title">Documentation</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                <i class="ti ti-dashboard me-2"></i>
                                Dashboard G√©n√©ral
                            </h2>
                            <div class="text-muted mt-1">
                                Vue d'ensemble de votre plateforme IA Souveraine
                            </div>
                        </div>
                        <div class="col-auto ms-auto">
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="Dashboard.refresh()">
                                    <i class="ti ti-refresh me-1"></i>
                                    Rafra√Æchir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    
                    <!-- Stats Cards -->
                    <div class="row row-deck row-cards mb-3">
                        <!-- Card 1 : Sant√© Globale -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-stats">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon bg-success-lt text-success">
                                            <i class="ti ti-heart-rate-monitor"></i>
                                        </div>
                                        <div class="ms-auto">
                                            <div class="stats-label">Sant√© Globale</div>
                                            <div class="stats-value" id="stat-health">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 2 : Documents RAG -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-stats">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon bg-info-lt text-info">
                                            <i class="ti ti-file-text"></i>
                                        </div>
                                        <div class="ms-auto">
                                            <div class="stats-label">Documents RAG</div>
                                            <div class="stats-value" id="stat-documents">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 3 : Workflows N8N -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-stats">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon bg-warning-lt text-warning">
                                            <i class="ti ti-refresh"></i>
                                        </div>
                                        <div class="ms-auto">
                                            <div class="stats-label">Workflows Actifs</div>
                                            <div class="stats-value" id="stat-workflows">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 4 : Conteneurs -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-stats">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon bg-primary-lt text-primary">
                                            <i class="ti ti-box"></i>
                                        </div>
                                        <div class="ms-auto">
                                            <div class="stats-label">Conteneurs</div>
                                            <div class="stats-value" id="stat-containers">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Services Status -->
                    <div class="row row-deck row-cards mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-server me-2"></i>
                                        √âtat des Services
                                    </h3>
                                    <div class="card-actions">
                                        <a href="#" class="btn btn-sm btn-primary" onclick="Dashboard.loadServices()" aria-label="Rafra√Æchir les services" title="Rafra√Æchir">
                                            <i class="ti ti-refresh"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body" id="services-list">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary"></div>
                                        <p class="text-muted mt-2">Chargement des services...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Metrics -->
                    <div class="row row-deck row-cards mb-3">
                        <!-- CPU & RAM -->
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-cpu me-2"></i>
                                        Ressources Syst√®me
                                    </h3>
                                </div>
                                <div class="card-body" id="system-metrics">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Links -->
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-link me-2"></i>
                                        Acc√®s Rapides
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <a href="studio.html" class="btn btn-outline-primary w-100">
                                                <i class="ti ti-sparkles me-2"></i>AI Studio
                                            </a>
                                        </div>
                                        <div class="col-6">
                                            <a href="admin.html" class="btn btn-outline-warning w-100">
                                                <i class="ti ti-settings me-2"></i>Console Admin
                                            </a>
                                        </div>
                                        <div class="col-6">
                                            <a href="architecture.html" class="btn btn-outline-success w-100">
                                                <i class="ti ti-layout-dashboard me-2"></i>Architecture
                                            </a>
                                        </div>
                                        <div class="col-6">
                                            <a href="components.html" class="btn btn-outline-info w-100">
                                                <i class="ti ti-components me-2"></i>Composants
                                            </a>
                                        </div>
                                        <div class="col-12">
                                            <a href="docs.html" class="btn btn-outline-secondary w-100">
                                                <i class="ti ti-book me-2"></i>Documentation
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- External Services -->
                                    <div class="mt-3">
                                        <h4 class="text-muted mb-2 small">Services Externes</h4>
                                        <div class="d-flex flex-wrap gap-2" id="external-services">
                                            <!-- G√©n√©r√© dynamiquement -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    OceanPhenix Admin Hub v1.0.0
                                </li>
                                <li class="list-inline-item">
                                    <span class="badge badge-sovereign">üá´üá∑ 100% Souverain</span>
                                </li>
                                <li class="list-inline-item">
                                    D√©cembre 2025
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api-client.js"></script>
    <script src="../assets/js/app.js"></script>
    
    <script>
        /**
         * Dashboard Page
         */
        const Dashboard = {
            data: {
                services: [],
                systemMetrics: null,
                stats: null
            },
            
            /**
             * Initialisation
             */
            async init() {
                console.log('üìä Initialisation du Dashboard');
                
                await this.loadAll();
                
                // √âcouter l'√©v√©nement de refresh
                window.addEventListener('app:refresh', () => this.loadAll());
            },
            
            /**
             * Charger toutes les donn√©es
             */
            async loadAll() {
                await Promise.all([
                    this.loadStats(),
                    this.loadServices(),
                    this.loadSystemMetrics(),
                    this.loadExternalServices()
                ]);
            },
            
            /**
             * Charger les statistiques
             */
            async loadStats() {
                try {
                    const health = await API.getHealth();
                    
                    // Sant√© globale
                    const healthPercent = health.health_percentage || 0;
                    document.getElementById('stat-health').textContent = Math.round(healthPercent) + '%';
                    
                    // Documents (exemple - √† adapter selon votre API)
                    try {
                        const docs = await API.getDocuments();
                        document.getElementById('stat-documents').textContent = docs.length || 0;
                    } catch (e) {
                        document.getElementById('stat-documents').textContent = 'N/A';
                    }
                    
                    // Workflows (placeholder)
                    document.getElementById('stat-workflows').textContent = 'N/A';
                    
                    // Conteneurs
                    document.getElementById('stat-containers').textContent = health.total_count || 'N/A';
                    
                } catch (error) {
                    console.error('Erreur chargement stats:', error);
                    Utils.showToast('Erreur de chargement des statistiques', 'error');
                }
            },
            
            /**
             * Charger la liste des services
             */
            async loadServices() {
                const container = document.getElementById('services-list');
                
                try {
                    const health = await API.getHealth();
                    this.data.services = Object.values(health.services || {});
                    
                    if (this.data.services.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center">Aucun service disponible</p>';
                        return;
                    }
                    
                    // G√©n√©rer le HTML
                    let html = '<div class="row g-2">';
                    
                    this.data.services.forEach(service => {
                        const statusColor = Utils.getStatusColor(service.status);
                        const statusLabel = Utils.getStatusLabel(service.status);
                        
                        html += `
                            <div class="col-md-4 col-lg-3">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="status-dot bg-${statusColor} me-2"></span>
                                            <div>
                                                <div class="fw-bold">${service.name}</div>
                                                <div class="text-muted small">${statusLabel}</div>
                                            </div>
                                        </div>
                                        ${service.response_time_ms ? `
                                            <div class="text-muted small mt-2">
                                                ${service.response_time_ms}ms
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                    
                } catch (error) {
                    console.error('Erreur chargement services:', error);
                    Utils.showError('services-list', 'Erreur de chargement des services');
                }
            },
            
            /**
             * Charger les m√©triques syst√®me
             */
            async loadSystemMetrics() {
                const container = document.getElementById('system-metrics');
                
                try {
                    const metrics = await API.getSystemHealth();
                    this.data.systemMetrics = metrics;
                    
                    const cpu = metrics.cpu_percent || 0;
                    const ram = metrics.memory_percent || 0;
                    const disk = metrics.disk_percent || 0;
                    
                    container.innerHTML = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>CPU</span>
                                <span class="fw-bold">${cpu.toFixed(1)}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${cpu > 80 ? 'bg-danger' : cpu > 60 ? 'bg-warning' : 'bg-success'}" 
                                     style="width: ${cpu}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>RAM</span>
                                <span class="fw-bold">${ram.toFixed(1)}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${ram > 80 ? 'bg-danger' : ram > 60 ? 'bg-warning' : 'bg-success'}" 
                                     style="width: ${ram}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-0">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Disque</span>
                                <span class="fw-bold">${disk.toFixed(1)}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${disk > 80 ? 'bg-danger' : disk > 60 ? 'bg-warning' : 'bg-success'}" 
                                     style="width: ${disk}%"></div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Erreur m√©triques syst√®me:', error);
                    container.innerHTML = '<p class="text-muted text-center">M√©triques non disponibles</p>';
                }
            },
            
            /**
             * Charger les services externes
             */
            loadExternalServices() {
                const container = document.getElementById('external-services');
                const services = CONFIG.getActive().SERVICES;
                
                let html = '';
                
                Object.entries(services).forEach(([name, url]) => {
                    if (url) {
                        html += `
                            <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="ti ti-external-link me-1"></i>${name}
                            </a>
                        `;
                    }
                });
                
                container.innerHTML = html || '<small class="text-muted">Aucun service configur√©</small>';
            },
            
            /**
             * Rafra√Æchir manuellement
             */
            async refresh() {
                Utils.showToast('Rafra√Æchissement en cours...', 'info');
                await this.loadAll();
                Utils.showToast('Dashboard mis √† jour', 'success');
            }
        };
        
        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', () => {
            Dashboard.init();
        });
    </script>
</body>
</html>

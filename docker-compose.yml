# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŒŠ OceanPhenix V10 - Orchestrateur Global
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Usage :
#   - Core seulement : docker compose up -d
#   - Tout : docker compose --profile all up -d
#   - Core + BI : docker compose --profile core --profile bi up -d
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: oceanphenix-v10

networks:
  proxy:
    name: v10_proxy
  internal:
    name: v10_internal

volumes:
  caddy_data: { name: v10_caddy_data }
  caddy_config: { name: v10_caddy_config }
  minio_data: { name: v10_minio_data }
  qdrant_data: { name: v10_qdrant_data }
  ollama_data: { name: v10_ollama_data }
  valkey_data: { name: v10_valkey_data }
  n8n_data: { name: v10_n8n_data }

  db_data: { name: v10_db_data } # Postgres global
  portainer_data: { name: v10_portainer_data }
  prometheus_data: { name: v10_prometheus_data }
  alertmanager_data: { name: v10_alertmanager_data }
  grafana_data: { name: v10_grafana_data }
  openwebui_data: { name: v10_openwebui_data }

services:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸŒ PROXY & INFRASTRUCTURE (Profile: core)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  caddy:
    image: caddy:latest
    container_name: v10-proxy
    restart: unless-stopped
    profiles: [ core, all ]
    ports:
      - "80:80"
      - "443:443"
    networks: [ proxy ]
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      # Config dynamique via API ou fichier montÃ©
      - ./core/proxy/Caddyfile:/etc/caddy/Caddyfile:ro
    environment:
      - ACME_AGREE=true
      - ACME_EMAIL=${ACME_EMAIL}
      - DOMAIN_DASHBOARD=${DOMAIN_DASHBOARD}
      - DOMAIN_API=${DOMAIN_API}
      - DOMAIN_MINIO=${DOMAIN_MINIO}
      - DOMAIN_S3=${DOMAIN_S3}
      - DOMAIN_CMS=${DOMAIN_CMS}
      - DOMAIN_N8N=${DOMAIN_N8N}
      - DOMAIN_BI=${DOMAIN_BI}
      - DOMAIN_STUDIO=${DOMAIN_STUDIO}
      - DOMAIN_MONITORING=${DOMAIN_MONITORING}
      - DOMAIN_PORTAINER=${DOMAIN_PORTAINER}

  portainer:
    image: portainer/portainer-ce:latest
    container_name: v10-portainer
    restart: unless-stopped
    profiles: [ core, all ]
    networks: [ internal ]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - "9443:9443"
      - "9002:9000"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“ˆ MONITORING (Profile: monitoring)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  prometheus:
    image: prom/prometheus:latest
    container_name: v10-prometheus
    restart: unless-stopped
    profiles: [ monitoring, all ]
    networks: [ internal ]
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./core/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./core/monitoring/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus_data:/prometheus
    depends_on:
      - alertmanager

  alertmanager:
    image: prom/alertmanager:latest
    container_name: v10-alertmanager
    restart: unless-stopped
    profiles: [ monitoring, all ]
    networks: [ internal, proxy ]
    ports:
      - "9093:9093"
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
    environment:
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    volumes:
      - ./core/monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ./core/monitoring/templates:/etc/alertmanager/templates:ro
      - alertmanager_data:/alertmanager

  grafana:
    image: grafana/grafana-oss:latest
    container_name: v10-grafana
    restart: unless-stopped
    profiles: [ monitoring, all ]
    networks: [ internal, proxy ]
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./core/monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./core/monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./core/monitoring/dashboards:/var/lib/grafana/dashboards:ro

  node-exporter:
    image: prom/node-exporter:latest
    container_name: v10-node-exporter
    restart: unless-stopped
    profiles: [ monitoring, all ]
    networks: [ internal ]
    ports:
      - "9100:9100"
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: v10-cadvisor
    restart: unless-stopped
    profiles: [ monitoring, all ]
    networks: [ internal ]
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§  INTELLIGENCE ARTIFICIELLE (Profile: rag)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ollama:
    image: ollama/ollama:latest
    container_name: v10-ollama
    restart: unless-stopped
    profiles: [ rag, all ]
    networks: [ internal ]
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  openwebui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: v10-studio
    restart: unless-stopped
    profiles: [ rag, all ]
    networks: [ internal, proxy ]
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - ENABLE_SIGNUP=true
      - QDRANT_URI=http://qdrant:6333
      - VECTOR_DB=qdrant
    volumes:
      - openwebui_data:/app/backend/data

  qdrant:
    image: qdrant/qdrant:latest
    container_name: v10-qdrant
    restart: unless-stopped
    profiles: [ rag, all ]
    networks: [ internal ]
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¦ DATA & STORAGE (Profile: core)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  minio:
    image: minio/minio:latest
    container_name: v10-minio
    restart: unless-stopped
    profiles: [ core, all ]
    networks: [ internal, proxy ]
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  postgres:
    image: postgres:16-alpine
    container_name: v10-db
    restart: unless-stopped
    profiles: [ core, all ]
    networks: [ internal ]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${ADMIN_PASSWORD_HASH} # Temporaire, utiliser un vrai secret
    volumes:
      - db_data:/var/lib/postgresql/data

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“± APPLICATIONS (Profile: apps)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Backend API (FastAPI)
  api:
    build: ./backend
    container_name: v10-api
    restart: unless-stopped
    profiles: [ core, all ]
    networks: [ internal, proxy ]
    ports:
      - "8000:8000"
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - MINIO_ENDPOINT=minio:9000
    depends_on: [ ollama, qdrant, minio ]

  # Dashboard (Hub OceanPhenix)
  dashboard:
    image: nginx:alpine
    container_name: v10-frontend
    restart: unless-stopped
    volumes:
      - ./hub-frontend-v2:/usr/share/nginx/html:ro
    profiles: [ core, all ]
    networks: [ proxy ]

  n8n:
    image: n8nio/n8n:latest
    container_name: v10-n8n
    restart: unless-stopped
    profiles: [ automation, all ]
    networks: [ internal, proxy ]
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
    volumes:
      - n8n_data:/home/node/.n8n

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š BUSINESS INTELLIGENCE (Profile: bi)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  superset:
    image: apache/superset:latest
    container_name: v10-bi
    restart: unless-stopped
    profiles: [ bi, all ]
    networks: [ internal, proxy ]
    ports:
      - "8088:8088"
    depends_on: [ postgres, valkey ]

  valkey:
    image: valkey/valkey:latest
    container_name: v10-cache
    restart: unless-stopped
    profiles: [ core, all ]
    networks: [ internal ]
    volumes:
      - valkey_data:/data
